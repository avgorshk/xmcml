1. Для каждого детектора посчитать распределение фотонов по максимальной глубине проникноваения в среду Z. У нас уже считается распределение фотонов по пробегам, нужно сделать то же самое, но по максимальной глубине. Т.е. в структуре фотона добавляешь параметр - текущая максимальная глубина. И как только фотон попадает на детектор - кладешь фотон в ячейку, соответствующую этой глубине. Это будет еще один массив (аналог timeScale) в результате для детектора.
2. Выполнить единичный расчет для однородной среды с параметрами из документа (только нужно взять достаточно мелкую сетку, чтобы в нее полосы убрались)
3. Сделать требуемые свертки. Если все верно, ты увидишь полосы правильного размера.